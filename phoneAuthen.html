<!DOCTYPE html>
<html>

<head>


</head>

<body>
    <div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">

        <header class="mdl-layout__header mdl-color-text--white mdl-color-text--light-blue-700">
            <div class="mdl-cell mdl-cell--12-col mdl-cel--12-col-table mdl-grid">
                <div class="mdl-layout__header-row mdl-cell mdl-cel--12-col mdl-cell---col-table">
                    <a href="#">
                        <h3>Firebase phone Authentication</h3>
                    </a>
                </div>
            </div>
        </header>
        <main>
            <div>
                <div>
                    <div>
                        <h2>
                            Phone number auth with invisible Recaptcha
                        </h2>
                    </div>
                    <div>
                        <p>Sign in with your phone number</p>
                        <form id="sign-in-form">
                            <div>
                                <label>Enter your phone number</label>
                                <input id="phone-number" type="text" name="phone">

                                <span>Input is not an international phone number</span>
                            </div>
                            <button id="sign-in-button">Sign in</button>
                        </form>
                        <button id="sign-out-button">Sign out</button>
                        <form id="verification-code-form">
                            <div>
                                <label>Enter your verification code</label>
                                <input type="text" name="" id="verification-code">
                                <span>Input is not an international phone number</span>

                            </div>
                            <input type="submit" value="verify code" id="verify-code-button">
                            <button id="cancel-verify-code-button">Cancel</button>

                        </form>
                    </div>
                </div>
                <div>
                    <div id="user-details-card">
                        <div>
                            <h2>
                                User Sign in status
                            </h2>
                        </div>
                        <div>
                            <div>
                                Firebase sign-in status: <span id="sign-in-status">unknow</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/4.10.0/firebase.js"></script>

    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyBF0TF5PQNteZwHVKiq_IqnQYDXmFE7CiM",
            authDomain: "proplante-7d75e.firebaseapp.com",
            databaseURL: "https://proplante-7d75e.firebaseio.com",
            projectId: "proplante-7d75e",
            storageBucket: "proplante-7d75e.appspot.com",
            messagingSenderId: "561205632101",
            appId: "1:561205632101:web:ba99b04a5568e667b0fa8c",
            measurementId: "G-J760F0W3ZF"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
    <script>
   
   firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    var uid = user.uid;
                    var email = user.email
                    var photoURL = user.photoURL;
                    var phonenumber = user.phonenumber;
                    var isAnonymous = user.isAnonymous
                    var displayName = user.displayName
                }
                updateSignInButtonUI();
                updateSignInFormUI();
                updateSignOutButtonUI();

                updateSignedInUserStatusUI();
                updateVerificationCodeFormUI();
            });
            document.getElementById('sign-out-button').addEventListener('click', onSignOutClick);
            document.getElementById('phone-number').addEventListener('keyup', updateSignInButtonUI);
            document.getElementById('phone-number').addEventListener('change', updateSignInButtonUI);

            document.getElementById('verification-code').addEventListener('keyup', updateVerificationCodeButtonUI);
            document.getElementById('verification-code').addEventListener('change', updateVerificationCodeButtonUI);

            document.getElementById('verification-code-form').addEventListener('submit', onVerifyCodeSubmit);
            document.getElementById('cancel-verify-code-button').addEventListener('click', cancelVerification);

            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('sign-in-button', {
                'size': 'invisible',
                'callback': function (response) {
                    onSignInSubmit();
                }
            });
            recaptchaVerifier.render().then(function (widgetId) {
                window.recaptchaWidgetId = widgetId;
                updateSignInButtonUI();
            });
        

        function onSignInSubmit() {
            if (isPhoneNumberValid()) {
                window.singingIn = true;
                updateSignInButtonUI();
                var phoneNumber = getPhoneNumberFromUserInput();
                var appVerifier = window.recaptchaVerifier;
                firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier)
                    .then(function (confirmationResult) {
                        window.confirmationResult = confirmationResult;
                        window.singingIn = false;
                        updateSignInButtonUI();
                        updateVerificationCodeFormUI();
                        updateVerificationCodeButtonUI();

                        updateSignInFormUI();
                    }).catch(function (error) {
                        console.log("error durong signInWithPhoneNumber");
                        window.alert("error durong signInWithPhoneNumber:\n\n" + error.code + "\n\n" + error
                            .message);
                        window.signingIn = false;
                        updateSignInFormUI();
                        updateSignInButtonUI();

                    });
            }
        }

        function onVerifyCodeSubmit(e) {
            e.preventDefault();
            if (!!getCodeFromUserInput()) {
                window.verifyingCode = true;
                updateVerificationCodeButtonUI();
                var code = getCodeFromUserInput();
                confirmationResult.confirm(code).then(function (result) {
                    var user = result.user;
                    window.verifyingCode = false;

                    updateVerificationCodeFormUI();
                }).catch(function (error) {
                    console.error("error while chacking verification code", error);
                    window.alert("error while chacking verification code: \n\n" + error.code + "\n\n" + error
                        .message);
                    window.verifyingCode = false;
                    updateSignInButtonUI();
                    updateVerificationCodeButtonUI();
                });
            }
        }

        function cancelVerification(e) {
            e.preventDefault();
            window.confirmationResult = null;

            updateVerifyCodeButtonUI();
            updateSignInFormUI();
        }

        function onSignOutClick() {
            firebase.auth().signOut();
        }

        function getCodeFromUserInput() {
            return document.getElementById('verification-code').value;
        }

        function getPhoneNumberFromUserInput() {
            return document.getElementById('phone-number').value;

        }

        function isPhoneNumberValid() {
            var pattern = /^\+[0-9\s\-\(\)]+$/;
            var phoneNumber = getPhoneNumberFromUserInput();
            return phoneNumber.search(pattern) !== -1;
        }

        function resetReCaptcha() {
            if (typeof grecaptcha !== 'undefined' && typeof window.recaptchaWidgetId !== 'undefined') {
                grecaptcha.reset(window.recaptchaWidgetId);

            }
        }

        function updateSignInButtonUI() {
         //   document.getElementById('sign-in-button').disabled = !isPhoneNumberValid() || !!window.signingIn;
         document.getElementById('sign-in-button').disabled = false;

        }

        function updateVerificationCodeButtonUI() {
            document.getElementById('verify-code-button').disabled = !!window.verifyingCode || !!getCodeFromUserInput();
        }

        function updateSignInFormUI() {
            if (firebase.auth().currentUser || window.confirmationResult) {
                document.getElementById('sign-in-form').style.display = 'none';
            } else {
                resetReCaptcha();
                document.getElementById('sign-in-form').style.display = 'block';
            }

        }

        function updateVerificationCodeFormUI() {
            if (!firebase.auth().currentUser && window.confirmationResult) {
                document.getElementById('verification-code-form').style.display = 'block';
            } else {
                document.getElementById('verification-code-form').style.display = 'none';

            }
        }

        function updateSignOutButtonUI() {
            if (firebase.auth().currentUser) {
                document.getElementById('sign-out-button').style.display = 'block';

            }
        }
        function updateSignedInUserStatusUI(){
            var user = firebase.auth().currentUser;
            if(user){
                document.getElementById('sign-in-status').style.display = 'Signed In';
            }else{
                document.getElementById('sign-in-status').style.display = 'Signed Out';

            }
        }
    </script>

</body>

</html>